<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Time-based features.</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Optimization common toolings</span> <span class="project-version">2.3.2</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="distribution.html"><div class="inner"><span>Distribution </span></div></a></li><li class="depth-1 "><a href="prng.html"><div class="inner"><span>prng</span></div></a></li><li class="depth-1  current"><a href="time_based.html"><div class="inner"><span>Time-based features.</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>automaton-optimization</span></div></div></li><li class="depth-2"><a href="automaton-optimization.distribution.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>distribution</span></div></a></li><li class="depth-3 branch"><a href="automaton-optimization.distribution.distribution-protocol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>distribution-protocol</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>impl</span></div></div></li><li class="depth-4 branch"><a href="automaton-optimization.distribution.impl.exponential.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>exponential</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.distribution.impl.factory.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>factory</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.distribution.impl.kixi-stats.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>kixi-stats</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.distribution.impl.uniform.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>uniform</span></div></a></li><li class="depth-4"><a href="automaton-optimization.distribution.impl.uniform-integer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>uniform-integer</span></div></a></li><li class="depth-3"><a href="automaton-optimization.distribution.registry.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-2"><a href="automaton-optimization.maths.html"><div class="inner"><span class="tree" style="top: -269px;"><span class="top" style="height: 278px;"></span><span class="bottom"></span></span><span>maths</span></div></a></li><li class="depth-3"><a href="automaton-optimization.maths.gamma.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gamma</span></div></a></li><li class="depth-2"><a href="automaton-optimization.prng.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>prng</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>impl</span></div></div></li><li class="depth-4 branch"><a href="automaton-optimization.prng.impl.built-in.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>built-in</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.prng.impl.tests.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.prng.impl.well.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>well</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.prng.impl.well-macros.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>well-macros</span></div></a></li><li class="depth-4"><a href="automaton-optimization.prng.impl.xoroshiro128.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>xoroshiro128</span></div></a></li><li class="depth-3 branch"><a href="automaton-optimization.prng.stateful.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>stateful</span></div></a></li><li class="depth-3 branch"><a href="automaton-optimization.prng.stateful-wrapper.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>stateful-wrapper</span></div></a></li><li class="depth-3"><a href="automaton-optimization.prng.stateless.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>stateless</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>sample</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>impl</span></div></div></li><li class="depth-4 branch"><a href="automaton-optimization.sample.impl.number-set.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>number-set</span></div></a></li><li class="depth-4"><a href="automaton-optimization.sample.impl.vector.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>vector</span></div></a></li><li class="depth-3"><a href="automaton-optimization.sample.sample-protocol.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>sample-protocol</span></div></a></li><li class="depth-2"><a href="automaton-optimization.time-based.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>time-based</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>impl</span></div></div></li><li class="depth-4 branch"><a href="automaton-optimization.time-based.impl.aggregate.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>aggregate</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.time-based.impl.aggregates.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>aggregates</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.time-based.impl.aggregator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>aggregator</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.time-based.impl.aggregator-item.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>aggregator-item</span></div></a></li><li class="depth-4"><a href="automaton-optimization.time-based.impl.storage-strategy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>storage-strategy</span></div></a></li><li class="depth-5 branch"><a href="automaton-optimization.time-based.impl.storage-strategy.contiguous.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>contiguous</span></div></a></li><li class="depth-5"><a href="automaton-optimization.time-based.impl.storage-strategy.deltas.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>deltas</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.time-based.impl.var-additive.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>var-additive</span></div></a></li><li class="depth-4 branch"><a href="automaton-optimization.time-based.impl.var-aggregated.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>var-aggregated</span></div></a></li><li class="depth-4"><a href="automaton-optimization.time-based.impl.var-latest.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>var-latest</span></div></a></li><li class="depth-3"><a href="automaton-optimization.time-based.protocol.html"><div class="inner"><span class="tree" style="top: -331px;"><span class="top" style="height: 340px;"></span><span class="bottom"></span></span><span>protocol</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><!--toc:start-->
<ul>
<li><a href="#time-based-features">Time-based features.</a></li>
<li><a href="#quick-start-for-additive-measures">Quick start for additive measures</a></li>
<li><a href="#quick-start-for-the-latest-time-based-values">Quick start for the <code>latest</code> time-based values.</a></li>
<li><a href="#other-tb-var-features">Other <code>tb-var</code> features</a></li>
<li><a href="#aggregators">Aggregators</a></li>
<li><a href="#tb-var-aggregated"><code>tb-var-aggregated</code></a></li>
<li><a href="#advanced">Advanced</a></li>
</ul>
<!--toc:end-->
<h1><a href="#time-based-features" id="time-based-features"></a>Time-based features.</h1>
<p>When a process creates some data over time, the time-based feature stores and manipulates measures of that data over time.</p>
<p>A measure is associating a <code>value</code> over time, at a certain <code>bucket</code>. All the measures of the same concept are stored together in a time-based variable <code>tb-var</code>.</p>
<p>There are two available behaviors for <code>time-based</code> features:</p>
<ul>
<li><code>latest</code> that is, like an inventory level, concerned with the latest value.</li>
<li><code>additive</code> that is, like a machine production, whose underlying concept is additive, so measures at the same buckets will be added.</li>
</ul>
<p>Even if those two features are similar, they are presented below separately, so we can illustrate the detailed results of each of them.</p>
<h2><a href="#quick-start-for-additive-measures" id="quick-start-for-additive-measures"></a>Quick start for additive measures</h2>
<p>You can create an additive variable, the so-called <code>tb-var-additive</code>, all measures leading to the same bucket are added.</p>
<p>By default, a non-set variable is defaulted to <code>0</code>.</p>
<pre><code class="language-clojure">(ns opt-tb-demo)
(require '[automaton-optimization.time-based :as opt-tb])
(-&gt; (opt-tb/tb-var-additive-deltas)
    (opt-tb/get-measure 10))
;;0
</code></pre>
<p>When a custom default value is set it is the value returned instead.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-additive-deltas -666)
    (opt-tb/get-measure 10))
;;-666
</code></pre>
<p>If measure <code>10</code> is done at bucket <code>3</code>, this value is returned by <code>get-measure</code> at bucket <code>10</code>.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-additive-deltas)
    (opt-tb/measure 10 3)
    (opt-tb/get-measure 10))
;;3
</code></pre>
<p>If more than one measure is done, <code>get-measure</code> at bucket <code>10</code> returns the sum of all measured values at 10.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-additive-deltas)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/measure 11 4)
    (opt-tb/get-measure 10))
;;5
</code></pre>
<p>The function <code>get-measures</code> allows an easy and efficient return of values for a collection of buckets. Note that buckets with no measure are set to the default value.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-additive-deltas)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/measure 11 4)
    (opt-tb/get-measures (range 8 14)))
;[0 0 5 4 0 0]

Note that order is preserved
```clojure
(-&gt; (opt-tb/tb-var-additive-deltas)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/measure 11 4)
    (opt-tb/get-measures (reverse (range 8 14))))
; [0 0 4 5 0 0]

</code></pre>
<h1><a href="#quick-start-for-the-latest-time-based-values" id="quick-start-for-the-latest-time-based-values"></a>Quick start for the <code>latest</code> time-based values.</h1>
<p>The <code>tb-var-latest</code> stores the measured values by the <code>bucket</code>. The returned value will be the latest value set for a <code>bucket</code> in the past. Note this example, similar to the first example of <code>additive</code> returns different values, as the second measure on the same date replaces the previous one.</p>
<p>If no measure is done at bucket <code>10</code> or before, then the default value is returned. Note that this returned value could be whatever, as no operation is done on it.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-latest-deltas :foobar)
    (opt-tb/measure 12 :a)
    (opt-tb/get-measure 10))
</code></pre>
<p>If a measure is done at bucket <code>10, then the default value is returned before</code>10<code>and</code>3` is returned after.</p>
<pre><code class="language-clojure">(as-&gt;
    (opt-tb/tb-var-latest-deltas :foobar)
    tb-var
  (opt-tb/measure tb-var 10 3)
  (mapv #(opt-tb/get-measure tb-var %)
        [9 10 11 20]))
;; [:foobar 3 3 3]
</code></pre>
<p>If more than one value is set on the same <code>bucket</code>, then only the last measured (in order of the <code>measure</code> function call) is returned.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-latest-deltas :foobar)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/get-measure 10))
;; 2
</code></pre>
<h1><a href="#other-tb-var-features" id="other-tb-var-features"></a>Other <code>tb-var</code> features</h1>
<p>Whatever the <code>tb-var</code> is built, there are other features than <code>measure</code> and <code>get-measure</code>.</p>
<p>The <code>get-measures</code> help to quickly translate and note the results are different from additive as expected.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-latest-deltas :foobar)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/measure 11 4)
    (opt-tb/get-measures (range 8 14)))
;;[:foobar :foobar 2 4 4 4]
</code></pre>
<p>The default value of a <code>tb-var</code> is returned with the <code>default</code> function.</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/tb-var-additive-deltas 3)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/measure 11 4)
    opt-tb/default)
;3
</code></pre>
<h1><a href="#aggregators" id="aggregators"></a>Aggregators</h1>
<p>Aggregators can group <code>bucket</code>s in <code>bucket-aggregate</code>.</p>
<p>An aggregator can simply group <code>bucket</code>s. <code>aggregator</code> function creates it, then you can use it to translate the <code>bucket</code> into an `aggregate``.</p>
<pre><code class="language-clojure">(-&gt; [#::opt-tb{:start-bucket 0
               :step 10}]
    opt-tb/aggregator
    (opt-tb/to-bucket-aggregate 40))
; 4
</code></pre>
<p>An <code>aggregates</code> validity input data could be checked, it returns <code>nil</code> if it is valid or the error map if not.</p>
<pre><code class="language-clojure">(opt-tb/validate-aggregates [#::opt-tb{:start-bucket 0
                                       :step 10}])
; nil

(opt-tb/validate-aggregates [#::opt-tb{:step 10}])
; [#:automaton-optimization.time-based{:start-bucket ["missing required key"]}]
</code></pre>
<p>If you apply <code>to-bucket-aggregate</code> to buckets wrapping the <code>bucket</code> definition. You’ll remark that outside the defined range, the <code>bucket-aggregate</code> returns <code>nil</code>.</p>
<pre><code class="language-clojure">(def agg
  (-&gt; [#::opt-tb{:start-bucket 10
                 :end-bucket 20
                 :step 5}]
          opt-tb/aggregator))

(mapv #(opt-tb/to-bucket-aggregate
        agg %)
      (range 8 22))
; [nil nil 0 0 0 0 0 1 1 1 1 1 nil nil]
</code></pre>
<p>If you need the valid <code>bucket-aggregate</code> matching the <code>bucket</code> you pass as parameters, you can use:</p>
<pre><code class="language-clojure">(-&gt; [#::opt-tb{:start-bucket 10
               :end-bucket 20
               :step 5}]
    opt-tb/aggregator
    (opt-tb/to-bucket-aggregates (range 8 22)))
; [0 1]
</code></pre>
<h1><a href="#tb-var-aggregated" id="tb-var-aggregated"></a><code>tb-var-aggregated</code></h1>
<p>To store data in <code>tb-var</code> in aggregates, you need to define an <code>aggregator</code>. The measures and queries are done at the <code>bucket</code> level, but the values are aggregated according to the <code>aggregator</code>. Note that, it behaves like a classical <code>tb-var</code>, for instance, it returns <code>nil</code> outside the definition. Note also that the <code>tb-var-aggregated</code> is relying on a <code>tb-var</code>, all properties of that <code>tb-var</code> are kept.</p>
<pre><code class="language-clojure">(def tb-var-agg1
  (-&gt; [#::opt-tb{:start-bucket 10
                 :end-bucket 20
                 :step 5}]
      opt-tb/aggregator
      (opt-tb/tb-var-aggregated (opt-tb/tb-var-additive-deltas))
      (opt-tb/measure 10 3)
      (opt-tb/measure 14 4)))

(mapv #(opt-tb/get-measure tb-var-agg1 %)
      [9 10 11 14 15 16])
; [nil 7 7 7 0 0]
</code></pre>
<h1><a href="#advanced" id="advanced"></a>Advanced</h1>
<p>It is not part of the API, but you can see how the underlying data are set, to better get the two underlying data structures:</p>
<pre><code class="language-clojure">(-&gt; (opt-tb/additive-contiguous)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/measure 11 4)
    (get-in [:storage :contiguous]))
;;[nil nil nil nil nil nil nil nil nil nil 5 4]

(-&gt; (opt-tb/tb-var-latest-deltas)
    (opt-tb/measure 10 3)
    (opt-tb/measure 10 2)
    (opt-tb/measure 11 4)
    (get-in [:storage :deltas]))
;;{10 5, 11 4}
</code></pre>
<p>Each feature is shipped with the two storage implementations:</p>
<pre><code class="language-clojure">(require '[automaton-optimization.time-based :as opt-tb])
(opt-tb/latest-contiguous)
(opt-tb/latest-deltas)
(opt-tb/additive-contiguous)
(opt-tb/tb-var-latest-deltas)
</code></pre>
</div></div></div></body></html>